
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is a logged-in admin
    function isAdmin() {
      return request.auth.uid != null;
    }

    // Rules for the main electionRooms collection
    match /electionRooms/{roomId} {
      // Anyone can read the public-facing details of an election room
      allow get: if true;
      // Admins can list all rooms on their dashboard
      allow list: if isAdmin();
      // Only admins can create, update, or delete rooms
      allow create, update, delete: if isAdmin();

      // Rules for the 'voters' subcollection (tracks who has voted)
      match /voters/{voterEmail} {
        // Admins can read the full list of voters' emails.
        allow list: if isAdmin();
        
        // Anyone can check if a SPECIFIC email has voted (for the "already voted" check).
        // Admins can also get a single voter document.
        allow get: if true; 

        // Anyone can create their voter record once. The app's logic prevents overwrites.
        allow create: if true;

        // Only admins can modify or delete voter records (not currently used).
        allow update, delete: if isAdmin();
      }

      // Rules for the 'votes' subcollection (stores individual anonymous votes)
      match /votes/{voteId} {
        // Only admins can list votes for aggregating results.
        allow list: if isAdmin();
        // No one can read a single, specific vote document to protect anonymity.
        allow get: if false;
        // Anyone can create a new vote (cast a ballot).
        allow create: if true;
        // Votes are immutable and cannot be changed or deleted.
        allow update, delete: if false;
      }
    }
  }
}
