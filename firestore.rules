rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is an admin (logged in)
    function isAdmin() {
      return request.auth != null;
    }

    match /electionRooms/{roomId} {
      // Allow admins to perform any action on election rooms.
      // Allow anyone to read the main room document (but not subcollections by default).
      allow read: if true;
      allow write: if isAdmin();
      
      // Explicitly allow admins to list all rooms for the dashboard.
      allow list: if isAdmin();

      match /votes/{voteId} {
        // Only admins can read individual vote records.
        // Anyone can create a new vote record as part of the voting transaction.
        allow read: if isAdmin();
        allow create: if true;
        allow update, delete: if false; // Votes are immutable
      }

      match /voters/{userId} {
        // Admins can read the full list of who has voted.
        // A user can create their own voter record during the voting process.
        allow read: if isAdmin();
        allow create: if true;
        allow update, delete: if false; // Voter records are immutable
      }
    }
  }
}
