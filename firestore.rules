
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an authenticated admin.
    function isAdmin() {
      return request.auth != null;
    }

    // Match all documents in the electionRooms collection.
    match /electionRooms/{roomId} {
      // Admins can do anything.
      allow read, write, delete: if isAdmin();
      
      // Public users can read the main room data to participate.
      allow get: if !isAdmin();

      // Match documents in the 'voters' subcollection (e.g., /electionRooms/{roomId}/voters/{email})
      match /voters/{voterId} {
        // Admins can do anything.
        allow read, write, delete: if isAdmin();
        
        // Public users can create and update their OWN voter status document.
        // This is crucial for tracking "in_room" and "completed" statuses.
        allow create, update: if !isAdmin();
      }

      // Match documents in the 'votes' subcollection.
      match /votes/{voteId} {
        // Admins can do anything.
        allow read, write, delete: if isAdmin();
        
        // Public users can CREATE votes. They cannot read, update, or delete them.
        allow create: if !isAdmin();
      }
      
      // Match documents in the 'reviews' subcollection.
      match /reviews/{reviewId} {
        // Admins can do anything.
        allow read, write, delete: if isAdmin();
        
        // Public users can CREATE reviews. They cannot read, update, or delete them.
        allow create: if !isAdmin();
      }
    }
  }
}
