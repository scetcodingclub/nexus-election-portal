
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Define rules for the electionRooms collection
    match /electionRooms/{roomId} {
      
      // RULE 1: Allow anyone to read the main election room document.
      // This is required for participants to see the candidates and positions.
      allow read: if true;

      // RULE 2: Allow authenticated admins to write/delete the main room document.
      allow write, delete: if request.auth != null;

      // RULE 3: Define rules for the 'voters' subcollection.
      match /voters/{voterId} {
        // Allow anyone to create or update a document in the voters subcollection.
        // This is necessary for tracking participant status ('in_room', 'completed').
        allow create, update: if true;
        
        // Allow admins to read/delete voter records.
        allow read, delete: if request.auth != null;
      }
      
      // RULE 4: Define rules for the 'votes' subcollection.
      match /votes/{voteId} {
        // Allow anyone to create a vote document. This is the submission itself.
        // Disallow reading, updating, or deleting to ensure anonymity and integrity.
        allow create: if true;
        allow read, update, delete: if request.auth != null;
      }

      // RULE 5: Define rules for the 'reviews' subcollection.
      match /reviews/{reviewId} {
        // Allow anyone to create a review document.
        // Disallow reading, updating, or deleting to ensure anonymity.
        allow create: if true;
        allow read, update, delete: if request.auth != null;
      }
    }
  }
}
